// Node.js Upload Files
// The Formidable Module

// There is a very good module 
// for working with file uploads, 
// called "Formidable".

// The Formidable module can be 
// downloaded and installed using NPM:

// C:\Users\Your Name>npm install formidable

// After you have downloaded the 
// Formidable module, you can 
// include the module in any application:

var formidable = require('formidable');
// Upload Files
// Now you are ready to make a web 
// page in Node.js that lets the user 
// upload files to your computer:

// Step 1: Create an Upload Form
// Create a Node.js file that writes 
// an HTML form, with an upload field:

// ExampleGet your own Node.js Server
// This code will produce an HTML form:

var http = require('http');

http.createServer(function (req, res) {
  res.writeHead(200, {'Content-Type': 'text/html'});
  res.write('<form action="fileupload" method="post" enctype="multipart/form-data">');
  res.write('<input type="file" name="filetoupload"><br>');
  res.write('<input type="submit">');
  res.write('</form>');
  return res.end();
}).listen(8080);


// Step 2: Parse the Uploaded File
// Include the Formidable module to be 
// able to parse the uploaded file once 
// it reaches the server.

// When the file is uploaded and parsed, 
// it gets placed on a temporary folder 
// on your computer.

// Example
// The file will be uploaded, and placed on a temporary folder:

var http = require('http');
var formidable = require('formidable');

http.createServer(function (req, res) {
  if (req.url == '/fileupload') {
    var form = new formidable.IncomingForm();
    form.parse(req, function (err, fields, files) {
      res.write('File uploaded');
      res.end();
    });
  } else {
    res.writeHead(200, {'Content-Type': 'text/html'});
    res.write('<form action="fileupload" method="post" enctype="multipart/form-data">');
    res.write('<input type="file" name="filetoupload"><br>');
    res.write('<input type="submit">');
    res.write('</form>');
    return res.end();
  }
}).listen(8080);
// Step 3: Save the File
// When a file is successfully uploaded 
// to the server, it is placed on a 
// temporary folder.

// The path to this directory can be 
// found in the "files" object, passed 
// as the third argument in the parse() 
// method's callback function.

// To move the file to the folder of 
// your choice, use the File System 
// module, and rename the file:

// Example
// Include the fs module, and move 
// the file to the current folder:

var http = require('http');
var formidable = require('formidable');
var fs = require('fs');

http.createServer(function (req, res) {
  if (req.url == '/fileupload') {
    var form = new formidable.IncomingForm();
    form.parse(req, function (err, fields, files) {
      var oldpath = files.filetoupload.filepath;
      var newpath = 'C:/Users/Your Name/' + files.filetoupload.originalFilename;
      fs.rename(oldpath, newpath, function (err) {
        if (err) throw err;
        res.write('File uploaded and moved!');
        res.end();
      });
 });
  } else {
    res.writeHead(200, {'Content-Type': 'text/html'});
    res.write('<form action="fileupload" method="post" enctype="multipart/form-data">');
    res.write('<input type="file" name="filetoupload"><br>');
    res.write('<input type="submit">');
    res.write('</form>');
    return res.end();
  }
}).listen(8080);



// How to Upload File using formidable module in Node.js ?

// A formidable module is used for parsing form data, 
// especially file uploads. It is easy to use and integrate 
// into your project for handling incoming form data 
// and file uploads.

// Installation of the formidable module:

// You can visit the link Install formidable module. 
// You can install this package by using this command.

// npm install formidable
// After installing the formidable module, you can 
// check your yards version in the command prompt 
// using the command.

// npm version formidable
// After that, you can just create a folder and 
// add a file for example index.js, To run this 
// file you need to run the following command.

// node index.js
// Project Structure:

// NOTE: ‘uploads’ is the folder where your files will be uploaded.

// Filename: 

// index.js: The below code should be in the index.js

const express = require('express');
const fs = require('fs');
const path = require('path')
const formidable = require('formidable');

const app = express();

app.post('/api/upload', (req, res, next) => {

	const form = new formidable.IncomingForm();
	form.parse(req, function (err, fields, files) {

		let oldPath = files.profilePic.filepath;
		let newPath = path.join(__dirname, 'uploads')
			+ '/' + files.profilePic.name
		let rawData = fs.readFileSync(oldPath)

		fs.writeFile(newPath, rawData, function (err) {
			if (err) console.log(err)
			return res.send("Successfully uploaded")
		})
	})
});

app.listen(3000, function (err) {
	if (err) console.log(err)
	console.log('Server listening on Port 3000');
});


// Steps to run the program:

// Make sure you have installed the express and 
// formidable module using the following commands:

// npm install formidable
// npm install express

// Run the index.js file using the below command:

// node index.js

// Now open POSTMAN to run this API and 
// send sample data as shown below: 

// Here in the body, we have passed send two fields, 
// one is the name of type=’Text’ and the other is 
// the profile pic of type=’File’ as shown above.

// Now go to your uploads folder, your file 
// is uploaded as shown below:


